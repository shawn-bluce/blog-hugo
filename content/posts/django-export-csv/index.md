---
title: "Django ç›¸å¯¹ä¼˜é›…åœ°å¯¼å‡º CSV"
slug: "django-export-csv"
date: "2020-06-28T14:40:00+0000"
lastmod: "2025-01-16T07:43:20+0000"
draft: false
tags:
  - "Django"
  - "CSV"
visibility: "public"
---
# 0X00 å‰è¨€

> ä¸€è§ç¨‹åºå‘˜ï¼Œç«‹åˆ»æƒ³åˆ° web å¼€å‘ï¼Œç«‹åˆ»æƒ³åˆ°åå°ç®¡ç†ç³»ç»Ÿï¼Œç«‹åˆ»æƒ³åˆ°æ•°æ®å±•ç¤ºï¼Œç«‹åˆ»æƒ³åˆ°æ•°æ®ç­›é€‰ç­›é€‰ï¼Œç«‹åˆ»æƒ³åˆ°æ•°æ®ç»Ÿè®¡ï¼Œç«‹åˆ»æƒ³åˆ°å¯¼å‡º Excel è¡¨æ ¼ã€‚äº§å“ç»ç†çš„æƒ³è±¡æƒŸåœ¨è¿™ä¸€å±‚èƒ½å¤Ÿå¦‚æ­¤è·ƒè¿›ã€‚ --é²è¿…ï¼šæˆ‘ä¸æ˜¯ï¼Œæˆ‘æ²¡æœ‰ï¼Œåˆ«çè¯´

![æˆ‘ä¸æ˜¯ï¼Œæˆ‘æ²¡æœ‰ï¼Œåˆ«çè¯´å•Š](https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200628225253.jpg)

è™½ç„¶ä¸Šé¢è¿™ç§è¯´æ³•æœ‰ç‚¹å¤¸å¼ äº†ï¼Œä¸è¿‡ç¡®å®å¾ˆå¤šå¾ˆå¤šå¾ˆå¤šäººåœ¨å·¥ä½œä¸­é‡åˆ°è¿‡ä¸æ­¢ä¸€æ¬¡çš„éœ€è¦åœ¨ä¸€ä¸ª web ç³»ç»Ÿé‡Œæ·»åŠ ä¸€ä¸ªâ€æ•°æ®å¯¼å‡ºâ€çš„åŠŸèƒ½ï¼Œè€Œä¸”é€šå¸¸éƒ½æ˜¯å¯¼å‡ºæˆ csv è¿™ç§æ–‡ä»¶ã€‚è‡ªç„¶æˆ‘ä¹Ÿé‡åˆ°äº†å¾ˆå¤šå¾ˆå¤šå¾ˆå¤šæ¬¡ï¼Œä¹Ÿå†™è¿‡é‚£ç§æœ€è ¢çš„æ‰‹æ‹¼é€—å·çš„ csv å¯¼å‡ºï¼Œè¿˜çœ‹è¿‡åˆ«äººæ•ˆæœæ›´å¥½ä»£ç é‡æ›´å°‘çš„ç‰ˆæœ¬ã€‚ä¹Ÿå°±åœ¨æ­¤æ€»ç»“ä¸€ä¸‹å…·ä½“è¿™ä¸ª csv å¯¼å‡ºè¯¥æ€ä¹ˆææ‰å¥½ã€‚

æœ€è ¢çš„æ–¹æ¡ˆå¯èƒ½å°±æ˜¯æˆ‘æœ€æ—©å®ä¹ çš„æ—¶å€™å†™å‡ºæ¥çš„é‚£ç§æ‰‹æ‹¼é€—å·çš„æ–¹æ¡ˆäº†ï¼Œä¸ºäº†å¤§å®¶åˆšåƒçš„æ—©åˆæ™šé¥­ç€æƒ³ï¼Œå°±ä¸ç»™å¤§å®¶çœ‹äº†ï¼Œçœå¾—åå‡ºæ¥æµªè´¹ç²®é£Ÿã€‚çœŸæ­£ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯è¿™ä¹ˆä¸¤ç§ï¼šä¸€ç§æ˜¯ä¼ ç»Ÿçš„æ‹¼æ¥äºŒç»´æ•°ç»„çš„æ–¹å¼æ¥æ¨¡æ‹Ÿè¡¨æ ¼ï¼Œç„¶åé€šè¿‡ Python çš„ csv åº“ç›´æ¥å¯¼å‡ºï¼›å¦ä¸€ç§æ˜¯ä½¿ç”¨ djcsv æ¥è¿›è¡Œå¯¼å‡ºã€‚ä¸‹é¢æ¥ç®€å•çœ‹ä¸€ä¸‹å˜ã€‚

# 0X01 åŸå§‹ csv å¯¼å‡º

å…¶å®ç®€å•çš„å¯¼å‡ºåŸå§‹çš„æ–¹æ³•å°±å¯ä»¥è§£å†³é—®é¢˜äº†ï¼Œä¸‹é¢åªåˆ—å‡ºé‡ç‚¹ä»£ç ã€‚é¦–å…ˆå¯¼å…¥ csv æ¨¡å—ï¼›ç„¶åæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç”¨æ¥ä¿å­˜è¿™æ¬¡å¯¼å‡ºçš„å†…å®¹ï¼›æ¥ä¸‹æ¥æŒ‰è¡Œå†™å…¥è¡¨å¤´ï¼›ç„¶åå¾ªç¯æ•´ä¸ª queryset æ„å»ºä¸€è¡Œè¡Œçš„æ•°æ®ä»è€Œå†™å…¥ï¼›æœ€ç»ˆå¯¼å‡ºå°±æˆåŠŸç»“æŸäº†ã€‚

```python
    import csv

    with open('export.csv', 'w') as f: # æ‰“å¼€å¾…ç”¨çš„æ–‡ä»¶
        csv_writer = csv.writer(f)  # ç”Ÿæˆä¸€ä¸ª csvwriter

        table_title = ['å§“å', 'æ€§åˆ«', 'ç”Ÿæ—¥']  # å‡†å¤‡è¡¨å¤´
        csv_writer.write_row(table_title)

        queryset = Student.objects.all().only('name', 'gender', 'birthday')
        for student in queryset:
            line = [
                student.name,
                student.gender,
                student.birthday.strftime('%Y-%m-%d'),
            ]
            csv_writer.write_row(line)
```

è¿™æ ·å¯¼å‡ºæ¥çš„æ–‡ä»¶å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„å†…å®¹äº†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€çœ¼æˆæœï¼ˆä¸æ˜¯è¯¸è‘›å¤§åŠ›ï¼Œæ˜¯æˆ‘ä»¬å¯¼å‡ºæ¥çš„ csv æ–‡ä»¶ğŸ¤£ï¼‰ï¼š å‘ç°é—®é¢˜äº†æ²¡ï¼Ÿæˆ‘ä»¬çš„æ€§åˆ«å‡ºç°äº†ä¸€ä¸¢ä¸¢é—®é¢˜ï¼Œæœ¬æ¥æ˜¯ç”¨ M/F æ¥å½“åšç”·å¥³æ¥å­˜çš„ï¼ˆè¿™ç§æƒ…å†µå…¶å®éå¸¸å¤šçš„ï¼Œæ¯”å¦‚ä½ çš„ç±»å‹å¯èƒ½ç”¨äº† integer ç„¶åç”¨ä¸€ä¸ª map å»æ˜ å°„åˆ°ä¸åŒçš„ä¸­æ–‡åä¸Šå»ï¼‰ï¼Œç°åœ¨å´æŠŠæ•°æ®åº“ä¸­çœŸå®çš„å†…å®¹å¯¼å‡ºæ¥äº†ã€‚

| å§“å | æ€§åˆ« | ç”Ÿæ—¥ |
| -â€”â€”â€”â€”â€” |
| Kevin Armstrong | F | 1988-01-02 |
| Patricia Robinson | F | 1988-01-02 |
| Michael Duffy | F | 1988-01-02 |
| Kathryn Hodge | M | 1988-01-02 |
| Justin Carlson | F | 1988-01-02 |
| Larry Jones | F | 1988-01-02 |
| Peter Palmer | F | 1988-01-02 |
| William Smith | F | 1988-01-02 |
| Karen Garcia | M | 1988-01-02 |
| Eric Williams | F | 1988-01-02 |
| Eduardo Bell | F | 1988-01-02 |
| Cynthia Lee | M | 1988-01-02 |
| Brandy Hoffman | F | 1988-01-02 |
| Emily Jones | F | 1988-01-02 |
| Kelly Perry | M | 1988-01-02 |
| Jamie Nixon | F | 1988-01-02 |
| Jeffrey Vega | F | 1988-01-02 |
| John Chen | M | 1988-01-02 |
| Laura Stevens | M | 1988-01-02 |
| Linda Robinson | M | 1988-01-02 |

å¦‚æœä½ è¯´è¿™ç§é—®é¢˜ä¸å¤§ï¼Œé‚£ç°åœ¨æˆ‘ä»¬è¦æ±‚åŠ ä¸€åˆ— â€æ˜¯å¦æˆå¹´â€œ ï¼Œç„¶åè¿™ä¸ªæ˜¯å¦æˆå¹´åˆæ²¡æœ‰å­˜ï¼Œåªæœ‰ç”¨ç”Ÿæ—¥æ¥è®¡ç®—ï¼Œé‚£å’‹æï¼Ÿå¯èƒ½åªæœ‰åœ¨`line = [xxxxx]`çš„åœ°æ–¹å†åŠ ä¸€è¡Œ`'æˆå¹´' if (datetime.datetime.now() - student.birthday).days / 365 >= 18 else 'æœªæˆå¹´'`æ‰è¡Œäº†ã€‚å½“ç„¶è¿™åªæ˜¯ç†æƒ³æƒ…å†µï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸€å¼ ä¸šåŠ¡è¡¨å¯èƒ½ä¼šæœ‰ 100 å¤šä¸ªå­—æ®µï¼Œå¯¼å‡ºçš„æ—¶å€™å¯èƒ½è¦ä»è¿™ 100 å¤šä¸ªå­—æ®µä¸­é€‰æ‹© 80 å¤šä¸ªå¯¼å‡ºæ¥ç„¶åè¿˜è¦å¯¼å‡ºä»–ä»¬å¤–é”®å…³è”çš„å…¶ä»–è¡¨çš„æ•°æ®ã€‚è¿™æ˜¯ç”±ä¸Šé¢è¿™ç§å†™æ³•å°±ä¼šè¶Šæ¥è¶Šé•¿ï¼Œè€Œä¸”å°¤å…¶æ˜¯å½“â€ä¸èƒ½ä»æ•°æ®åº“ä¸­ç›´æ¥å–â€œçš„æ•°æ®è¶Šæ¥è¶Šå¤šçš„æ—¶å€™å°±ä¼šéº»çƒ¦äº†ã€‚ä¸‹é¢ä»‹ç»çš„è¿™ç§ä½¿ç”¨ djcsv å¯¼å‡ºçš„æ–¹æ³•å°±å¾ˆå¥½ç”¨äº†ã€‚

# 0X02 ä½¿ç”¨ djcsv å¯¼å‡º

è¿™ç§æ–¹æ³•éœ€è¦å®‰è£…ä¸€ä¸ªä¸‰æ–¹åº“ djcsv ï¼Œé¡¾åæ€ä¹‰å®ƒå°±æ˜¯ç”¨æ¥æ–¹ä¾¿ Django å¯¼å‡º csv æ–‡ä»¶çš„ã€‚è¿™å¨ä»£ç çš„å…·ä½“è§£é‡Šå°±ç›´æ¥å†™åœ¨ä¸‹é¢æ³¨é‡Šé‡Œäº†ã€‚

```python
    from djcsv import write_csv

    def export_csv():
        queryset = Student.objects.all()
        queryset_values = queryset.values(
            'name',
            'gender',
            'birthday',
            'teacher__name',    # è·¨è¡¨ä¹Ÿæ˜¯å¯ä»¥çš„
            'teacher__gender',
        )

        # å¯¼å‡ºå­—æ®µè¡¨å¤´
        field_header_map = {
            'name': 'å§“å',
            'gender': 'æ€§åˆ«',
            'birthday': 'ç”Ÿæ—¥',
            'teacher__name': 'è€å¸ˆå§“å',
            'teacher__gender': 'è€å¸ˆæ€§åˆ«',

        }

        # æ ¼å¼åŒ–æ•°æ®
        gender_dict = dict(Student.GENDER_CHOICES)
        """
        Student.GENDER_CHOICES = (
            ('M', 'ç”·'),
            ('F', 'å¥³),
        )
        """

        field_serializer_map = {    # æŠ˜é¡µæœºå°±æ˜¯ä¸ºä»€ä¹ˆè¦å« serializer çš„æ–¹æ³•äº†ï¼Œå› ä¸ºç¡®å®æœ‰ä¸€ä¸ªç¿»è¯‘åœ¨è¿™å„¿
            'gender': (lambda x: gender_dict.get(x, 'å…¶ä»–')),
            'teacher_gender': (lambda x: gender_dict.get(x, 'å…¶ä»–')),
        }

        with open('export.csv', 'w') as csv_file:
            write_csv(
                queryset_values,
                csv_file,
                field_header_map=field_header_map,
                field_serializer_map=field_serializer_map
            )
```